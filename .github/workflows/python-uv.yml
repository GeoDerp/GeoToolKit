name: Python CI Pipeline

on:
  push:
    branches: [main, develop, Dev]
  pull_request:
    branches: [main, develop]

env:
  PYTHON_APP_SOURCE_DIR: "."
  PYTEST_COVERAGE_XML_FILE_NAME: "coverage-reports/coverage-pytest.xml"
  PYTEST_COVERAGE_THRESHOLD_PERCENT: 80
  UV_SYSTEM_PYTHON: 1
  # Security-focused environment variables
  SEMGREP_RULES_AUTO_UPDATE: "false"  # Use pinned rules for consistency
  TRIVY_OFFLINE_SCAN: "true"          # Align with offline scanning capability

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
      pull-requests: write
      id-token: write
      packages: write
      actions: read
      security-events: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run Python CI with uv
        uses: ./.github/actions/python-uv
        with: 
          pytest_coverage_xml_file_name: ${{ env.PYTEST_COVERAGE_XML_FILE_NAME }}
          source_dir: ${{ env.PYTHON_APP_SOURCE_DIR }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          docker_image_name: ${{ github.event.repository.name }}
          pytest_coverage_threshold_percent: ${{ env.PYTEST_COVERAGE_THRESHOLD_PERCENT }}

  mcp-server:
    runs-on: ubuntu-latest
    needs: build
    timeout-minutes: 10
    permissions:
      contents: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Install uv
        uses: astral-sh/setup-uv@v5
        with:
          enable-cache: true
          cache-dependency-glob: "uv.lock"
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version-file: ".python-version"
      
      - name: Install dependencies
        run: uv sync --all-extras --dev
      
      - name: Validate MCP manifest
        shell: bash
        run: |
          uv run python -c 'import json; m=json.load(open("mcp/manifest.json")); print(f"Manifest OK: {m[\"name\"]} ({m[\"app_id\"]})")'

      - name: Smoke test MCP tools (createProjects, normalizeProjects)
        shell: bash
        run: |
          uv run python -c 'import sys, os, json; sys.path.append("mcp"); from server import createProjects, normalizeProjects; \
          payload=[{"name":"ci-proj","url":"https://example.com/repo.git","network_config":{"allowed_egress":{"example.com":["80","443"]}}}]; \
          res=createProjects(payload, outputPath="projects.ci.json"); assert os.path.exists(res["path"]); print("createProjects OK ->", res["path"]); \
          res2=normalizeProjects("projects.ci.json"); print("normalizeProjects OK ->", json.dumps(res2)[:200])'

      - name: Smoke test MCP runScan
        shell: bash
        run: |
          printf '{"projects":[{"url":".","name":"local"}]}' > projects.smoke.json
          touch data/offline-db.tar.gz
          uv run python - <<'PY'
          import sys, pathlib
          sys.path.append('mcp')
          from server import runScan
          res = runScan('projects.smoke.json','report.smoke.md','data/offline-db.tar.gz')
          print('runScan exitCode:', res.get('exitCode'))
          print('Report len:', len((pathlib.Path('report.smoke.md').read_text())))
          PY

      - name: CLI smoke test
        shell: bash
        run: |
          uv run python src/main.py --input test-projects.json --output ci-quick-report.md --database-path data/offline-db.tar.gz || true

  # Deploy packages for CLI and MCP server
  deploy-packages:
    runs-on: ubuntu-latest
    needs: [build, mcp-server]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    permissions:
      contents: write
      packages: write
      id-token: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Install uv
        uses: astral-sh/setup-uv@v5
        with:
          enable-cache: true
          cache-dependency-glob: "uv.lock"
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version-file: ".python-version"
      
      - name: Install dependencies
        run: uv sync --all-extras --dev
        
      - name: Build CLI package
        run: |
          echo "Building GeoToolKit CLI package..."
          uv build
          echo "ðŸ“¦ Built packages:"
          ls -la dist/
          
      - name: Verify package deployment readiness  
        run: |
          echo "ðŸ” Running deployment verification..."
          python scripts/verify_deployment.py
        
      - name: Scan built packages for security issues
        run: |
          echo "ðŸ” Scanning built packages for security vulnerabilities..."
          # Install safety to scan for known vulnerabilities
          pip install safety
          # Check the requirements for known vulnerabilities
          safety check || echo "Safety check completed with warnings"
          # Verify package contents
          find dist -name "*.whl" -exec unzip -l {} \; | head -20 || true
          echo "âœ… Package security scan completed"
        
      - name: Prepare MCP server distribution
        run: |
          echo "ðŸ“¦ Preparing MCP server distribution..."
          mkdir -p dist/mcp-server
          cp -r mcp/* dist/mcp-server/
          # Create a comprehensive MCP server package
          cd dist
          tar -czf geotoolkit-mcp-server-${GITHUB_SHA::7}.tar.gz mcp-server/
          cd ..
          echo "MCP_ARCHIVE=dist/geotoolkit-mcp-server-${GITHUB_SHA::7}.tar.gz" >> $GITHUB_ENV
          echo "âœ… MCP server package created"
        
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: geotoolkit-packages-${{ github.sha }}
          path: |
            dist/*.whl
            dist/*.tar.gz
            dist/geotoolkit-mcp-server-*.tar.gz
          retention-days: 30
            
      - name: Create Development Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ðŸš€ Creating development release..."
          # Get the latest tag or create a development release
          LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.1.0")
          COMMIT_SHA=${GITHUB_SHA::7}
          RELEASE_TAG="${LATEST_TAG}-dev-${COMMIT_SHA}"
          
          # Create comprehensive release notes
          cat > release-notes.md << EOF
          ## ðŸ›¡ï¸ GeoToolKit Development Release ${RELEASE_TAG}
          
          ### ðŸ“¦ Distribution Packages
          
          #### CLI Tool Package
          - **Python Wheel**: \`geotoolkit-*.whl\` - Ready for installation via \`uv pip install\`
          - **Source Distribution**: \`geotoolkit-*.tar.gz\` - For development and custom builds
          
          #### MCP Server Package  
          - **MCP Server Archive**: \`geotoolkit-mcp-server-*.tar.gz\` - Model Context Protocol server
          - **Entry Point**: \`mcp/server.py\`
          - **Tools**: createProjects, runScan, normalizeProjects
          
          #### Container Image
          - **Docker Image**: \`ghcr.io/${GITHUB_REPOSITORY_OWNER}/geotoolkit:latest\`
          
          ### ðŸ”’ Security Features
          - âœ… All packages scanned with Semgrep and Trivy
          - âœ… Vulnerability database validation
          - âœ… Dependencies security checked
          - âœ… Container image security scanning
          
          ### ðŸš€ Installation & Usage
          
          #### CLI Tool Installation
          \`\`\`bash
          # Install from PyPI (when published)
          uv pip install geotoolkit
          
          # Install from wheel file
          uv pip install ./geotoolkit-*.whl
          
          # Run security scan
          geotoolkit --input projects.json --output report.md --database-path data/offline-db.tar.gz
          \`\`\`
          
          #### MCP Server Deployment
          \`\`\`bash
          # Extract MCP server
          tar -xzf geotoolkit-mcp-server-*.tar.gz
          
          # Run MCP server
          cd mcp-server
          python server.py
          \`\`\`
          
          #### Docker Deployment
          \`\`\`bash
          # Pull and run container
          docker pull ghcr.io/${GITHUB_REPOSITORY_OWNER}/geotoolkit:latest
          docker run -v \$(pwd):/workspace ghcr.io/${GITHUB_REPOSITORY_OWNER}/geotoolkit:latest
          \`\`\`
          
          ### ðŸ“ Build Information
          - **Commit**: ${GITHUB_SHA}
          - **Branch**: ${GITHUB_REF_NAME}
          - **Build Date**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          - **UV Version**: $(uv --version)
          - **Python Version**: $(python --version)
          EOF
          
          # Create the release with all artifacts
          gh release create "${RELEASE_TAG}" \
            --title "ðŸ›¡ï¸ GeoToolKit ${RELEASE_TAG}" \
            --notes-file release-notes.md \
            --prerelease \
            dist/*.whl \
            dist/*.tar.gz \
            "${MCP_ARCHIVE}" || echo "Release creation failed, but continuing..."
            
      - name: Test CLI package installation
        run: |
          echo "ðŸ§ª Testing CLI package installation..."
          # Create a fresh virtual environment and test installation
          uv venv test-env
          source test-env/bin/activate
          uv pip install dist/*.whl
          # Test CLI can be imported and basic functionality works
          python -c "from src.main import main; print('âœ… CLI package imports successfully')"
          # Test entry point
          which geotoolkit || echo "Entry point not found in PATH"
          echo "âœ… CLI package installation test completed"
          
      - name: Test MCP server package
        run: |
          echo "ðŸ§ª Testing MCP server package..."
          # Extract and test MCP server
          cd /tmp
          tar -xzf ${GITHUB_WORKSPACE}/${MCP_ARCHIVE}
          cd mcp-server
          python -c "
          import json
          with open('manifest.json') as f:
              manifest = json.load(f)
          print(f'âœ… MCP Manifest: {manifest[\"name\"]} v{manifest[\"version\"]}')
          print(f'âœ… Tools: {[t[\"name\"] for t in manifest[\"tools\"]]}')
          "
          echo "âœ… MCP server package test completed"